@model IEnumerable<WeatherStation.Models.MesuresHumiditeClimat>
@{
    System.Globalization.CultureInfo customCulture = (System.Globalization.CultureInfo)System.Threading.Thread.CurrentThread.CurrentCulture.Clone();
    customCulture.NumberFormat.NumberDecimalSeparator = ".";
    System.Threading.Thread.CurrentThread.CurrentCulture = customCulture;
}
<div id = "vertical2_Humidite" style = "height:95%; width: 100%;">
    <div id = "top-pane1">
        <ul id = "menu_date_hum">
            <li id = "Horaire_hum" style = "width:100px">Horaire</li>
            <li id = "Journaliere_hum" style = "width:100px">Journaliére </li>
            <li id = "Hebdomadaire_hum">Hebdomadaire </li>
            <li id = "mensuelle_hum" style = "width:100px">Mensuelle </li>
            <li id = "periodique_hum">Periodique </li>
        </ul>
        <ul id="menu_reporting_hum">
            <li onClick = "clickMonBoutonExcel();"><img id="MonBoutonExcel" src="../../Content/images/excel.png" style="margin:0;" /></li>
            <li onClick = "clickMonBoutonPdf();"><img id="MonBoutonPdf" src="../../Content/images/curve.png"/></li>
            <li><img src = "../../Content/images/pdf.jpeg" /></li>
            <li><img id = "refresh" src="../../Content/images/refresh.png" /></li>
            <li><img id = "colorpickerHum" onClick = "clickColorPickerHum();"></img></li>
        </ul>
        <div id="window2" style = "display:none" >
            <center>
                <br /><br />
                    <strong><label for = "start">date debut:</label></strong><input id = "start" style = "width: 200px" />
                <br /><br />
                    <strong><label for = "end">date fin:</label></strong><input id = "end" style = "width: 200px" />
                <br /><br />
                <button type = "button" id = "check"  >Valider</button>
                <button type = "button" id = "Annuler_hum"  >Annuler</button>
                <br /><br />
            </center>  
        </div>
    </div>
    <div id = "middle-pane1">
        <div id = "stock-chart_hum" style="height: 95%"></div>
        <div id = "loading"></div>
    </div>
    <div id = "bottom-pane1">
        <div id = "grid_hum" style="height: 100%"></div>
    </div>
</div>

<script type = "text/javascript">

    $("#vertical2_Humidite").kendoSplitter({
        orientation: "vertical",
        panes: [
            { collapsible: true, size: "6%" },
            { collapsible: true, size: "64%" },
            { collapsible: true, size: "30%" }
        ]
    });
    
    var list_hum1 = [], list_hum2 = [], orders = [], id = 1,
        list_hum1_min = '@Model.Where(i => i.HumiditeClimat != null).Min(j => j.HumiditeClimat)',
        list_hum1_max = '@Model.Where(i => i.HumiditeClimat != null).Max(j => j.HumiditeClimat)';
    @foreach (var mesures in Model)
    {
        @:if ('@mesures.HumiditeClimat' != '') {
            @:list_hum1.push(@mesures.HumiditeClimat);
            @:orders.push({
                @:ID: id ++,
                @:OrderDate: '@mesures.DateMesure.ToString("yyyy/MM/dd HH:mm:ss")',
                @:Humidite: '@mesures.HumiditeClimat',
            @:});
        @:}
        @:else {
            @:list_hum1.push(null);
        @:}
        @:list_hum2.push('@mesures.DateMesure.ToString("yyyy/MM/dd HH:mm:ss")');
    }

       function clickColorPickerHum() {
            colorpicker.open();
        }

        var colorpicker = $("#colorpickerHum").kendoColorPicker({
            change: function (e) {
                //kendoConsole.log("Change in picker #" + this.element.attr("id") + " :: " + e.value);
                var stockChart = $("#stock-chart_hum").data("kendoStockChart");
                stockChart.options.series[0].color = e.value;
                stockChart.options.valueAxis[0].color = e.value;
                stockChart.options.valueAxis[0].labels.color = e.value;
                stockChart.options.valueAxis[0].line.color = e.value;
                stockChart.options.valueAxis[0].title.color = e.value;
                stockChart.options.series[2].color = e.value;
                stockChart.refresh();
            },
            //  toolIcon: "k-foreColor"
        }).data("kendoColorPicker");

    var list_seuil = [];
    $.ajax({
        url: '../../UserSession/SeuilsHumidity',
        type: 'GET',
        data: { idNoeudClimat: @Model.ElementAt(0).IdParentNode},
        dataType: 'json',
        async: false,
        success: function (res) {
            list_seuil.push(res.seuilHumiditeAirInf);
            list_seuil.push(res.seuilHumiditeAirSupp);
        }
    });

    function  Selection_Courbe(x)
    {
        var chart = $("#stock-chart_hum").data("kendoStockChart");
        var date =x.toString();
        var datefinale = new Date(Number(date.substring(0,4)),(Number(date.substring(5,7)))-1,Number(date.substring(8,10)),Number(date.substring(11,13)),Number(date.substring(14,16)),00);
        var select=0;
        for(var d=0;d<chart.series[0].data.length;d++)
        {
            var dattttttttttee = new Date(chart.series[0].data[d].x);
            if((datefinale.getFullYear()==dattttttttttee.getFullYear())&&(datefinale.getMonth()==dattttttttttee.getMonth())&&(datefinale.getDay()==dattttttttttee.getDay())&&(datefinale.getHours()==dattttttttttee.getHours())&&(datefinale.getMinutes()==dattttttttttee.getMinutes())&&(datefinale.getSeconds()==dattttttttttee.getSeconds())&&((chart.series[0].data[d].y)!=null))
            {
                select=d;
            }
        }

        chart.series[0].data[select].select();
        chart.series[0].markers.visible = true;
    }

    function onChangeHum(arg) {

        var grid_hum = $("#grid_hum").data("kendoGrid");
        var rows_hum = grid_hum.select();
        var select_hum = grid_hum.items().index(rows_hum); //alert("rows length: " + rows.length + "\nRows index: " + select + "\nRows uid: " + rows.uid);
        
        if (select_hum != -1) {

            $(".k-grid-content").animate({
                scrollTop: ($('[data-uid="' + grid_hum.dataItem(rows_hum).uid + '"] ').offset().top - $(".k-selectable").offset().top)
            }, 800);
                        
            var stockChartHum = $("#stock-chart_hum").data("kendoStockChart");
            rows_hum.each(function(index, row) {
                var selectedItemHum = grid_hum.dataItem(row);
//                alert("rows: " + selectedItem.ID + ", " + selectedItem.OrderDate + ", " + selectedItem.Temperature);
                var index = jQuery.inArray(selectedItemHum.Humidite, stockChartHum.options.series[0].data);
//                alert("index: " + index); alert(stockChart.options.series[0].data[index] + "\n" + selectedItem.Temperature);
                $(".k-tooltip").show();
            });
        }
    }

    $("#grid_hum").kendoGrid({
        dataSource: {
            data: orders,
            pageSize: 50
        },
        height: '99%',
        change: onChangeHum,
        selectable: "multiple",
        scrollable: true,
        groupable: false,
        sortable: true,
        pageable: {
            refresh: true,
            pageSizes: true,
            buttonCount: 3
        },
        dataBound : onDataBound,
        columns: [{
            field: "ID",
            title: "ID",
            width: 50,
            headerAttributes : {
                style: "text-align:center"
            }
        },{
            field: "OrderDate",
            title: "Date",
            format: "{0:dd/MM/yyyy HH:mm:ss}",
            width: 100,
            headerAttributes : {
                style: "text-align:center"
            }
        },
        {
            field: "Humidite",
            title: "Humidité %",
            width: 100,
            headerAttributes : {
                style: "text-align:center"
            }
        }]
    });

    function onDataBound(arg) {
        var grid = $("#grid_hum").data("kendoGrid");
        var gridData = grid.dataSource.view();
        for (var i = 0; i < gridData.length; i++) {
            //get the item uid
            var currentUid = gridData[i].uid;
            if (gridData[i].Humidite >  list_seuil[1]) {
                var currenRow = grid.table.find("tr[data-uid='" + currentUid + "']");
                $(currenRow).css("background-color", "#f4ada6");
            }
            else if (gridData[i].Humidite < list_seuil[0]) {
                //find the row based on the uid and the custom class
                var currenRow = grid.table.find("tr[data-uid='" + currentUid + "']");
                $(currenRow).css("background-color", "#c6e6ff");
            }
        }

    }

    $("#stock-chart_hum").kendoStockChart({
        title: {
            text: "Date : " + kendo.format('{0:dd/MM/yyyy}',new Date()),
            color: "#000000",
            font: "12px sans-serif",
        },
        dateField: null,
        series: [{
            name: "humidité",
            type: "line",
            style: "smooth",
            //field: "Temperature",
            data: list_hum1,
            color:"#492970",
            markers: {
                visible : false,
            },
            tooltip: {
                visible: true,
                template: "Time=#= kendo.format('{0:dd/MM/yyyy HH:mm}',category) # ; #= series.name # = #= value #%"
            },
        },{
            name: "Seuil",
        }],
        valueAxis: [{
            name: 'humidité',
            data: list_hum1,
            color:"#492970",
            labels: {
                format: "{0}"
            },
            min: Math.floor(list_hum1_min /*- (list_hum1_max - list_hum1_min) * 0.1*/),
            max: Math.ceil(list_hum1_max /*+ (list_hum1_max - list_hum1_min) * 0.1*/),
            title: {
                text: "Humidité %",
                font: "12px sans-serif",
            },
            notes: {
                label:{
                    text :'seuil min',
                    position:'outside',
                    color: "#a0a700",
                },   
                visible: true,
                line: {
                    length:1100,
                    color: "#a0a700",
                },
                data: [{
                    value: list_seuil[0],
                },
                {
                    value: list_seuil[1],
                    label: {
                        text: "seuil max"
                    }, 
                    position:'outside'
                }]
            },
            plotBands: [{
                from: -5,
                to: list_seuil[0],
                color: "#f5f5f5"
            },
            {        
                from: list_seuil[1],
                to: 120,
                color: "#f5f5f5"
            }]
        }],
        legend: {
            position: "bottom",
            visible: true,
            border: {
                width: 2,
                color: "grey",
                dashType: "solid"
            },
        },
        xAxis:{
            color:"#492970",
            labels: {
                template: "#= kendo.format('{0}',value/60) #"
            }
        },
        categoryAxis: {
            categories: list_hum2,
            type: "date",
            baseUnit: "minutes",
            line:{
                color:"#492970",
            },
            labels: {
                visible: true,
                step: 120
            },
            majorGridLines: {
                visible: false,
            },
            majorTicks: {
                visible: true,
                size: 4,
                step: 60,
            }
        },
        navigator: {
            dateField: null,
            hint: {
                // hint template
                template: "From: #= from # To: #= to #",
                visible: false,
            },
            categoryAxis: {
                categories: list_hum2,
                type: "date",
                autoBaseUnitSteps:{
                    minutes:[15] ,
                    hours:[2],
                }
            },
            select: {
                        from: list_hum2[0],
                        to:list_hum2[list_hum2.length - 1],
            },
            series:{
                type: "area",
                area: {
                    line: {
                        style: "smooth"
                    }
                },
                data: list_hum1,
                color: "#492970",
            },   
//                select: {
//                    from: list_hum2[0],
//                    to: list_hum2[(list_hum2.length)-1]
//                }       
        },
        seriesClick: onSeriesClickHum,
        legendItemClick: onLegendItemClick,
    });

    function onSeriesClickHum(e) {
        var grid_hum = $("#grid_hum").data("kendoGrid");
        var data_hum = grid_hum.dataSource.data();
        var res_hum = $.grep(data_hum, function (d) {
            return /*d.OrderDate == e.category &&*/ d.Humidite == e.value;
        });
        selectRowHum(e.category, e.value);
    }

    function selectRowHum(Datee,temp)
    {
        var grid_hum = $("#grid_hum").data("kendoGrid"),
            view_hum = grid_hum.dataSource.view();
        var rows_hum = $.grep(view_hum, function(item) {
            return item.Humidite === temp && String(item.OrderDate) === String(Datee);
        }).map(function(item) {  //alert('map: ' + item.uid);
            return grid_hum.tbody.find(">[data-uid=" + item.uid + "]");
        });
        grid_hum.clearSelection(); grid_hum.select(rows_hum);
    }

    function onLegendItemClick(e) {
    }
</script>

@*Menu forms of Selection & Reporting*@
<script type="text/javascript">

    $("#menu_date_hum").clone(true).find(".k-state-active").removeClass("k-state-active");    
    $("#menu_date_hum").kendoMenu({
    }).css({
        'float': 'left',
//            'margin-top': $("#image").height() / 4
    });
    
    $("#menu_reporting_hum").clone(true).find(".k-state-active").removeClass("k-state-active");
    $("#menu_reporting_hum").kendoMenu({
    }).css({
        'float': 'right',
        'height': $("#menu_date_hum").height()
//          'margin-right': 30,
//          'position': 'absolute',
//          'left': '50%',
//          'top': '50%',
//          'margin-left': -$("#image").width() / 2,
//            'margin-top': $("#image").height() / 4
    });

</script>

@*Period Popup Form*@
<script type='text/javascript'>

    var undo = $("#undo").bind("click", function () {
        $("#window2").data("kendoWindow").center().open();
    });
    undo.show();

    var onClose = function () {
        undo.show();
    };

    if (!$("#window2").data("kendoWindow")) {
        $("#window2").kendoWindow({
            //            width: "400px",
            title: "Choix periode",
            actions: ["Close"],
            close: onClose
        });
    }

</script>
               

@*ChoixHeure*@
<script type='text/javascript'>

    $("#Horaire_hum").kendoDateTimePicker({
        value: new Date(),
        close: myfunctionheurrefresh,
    });

    $(".k-input").css("background-color", "#e8e8e8");
    $(".k-state-hover> .k-picker-wrap > .k-state-default").css("visibility", "hidden");

    var datepicker_hour = $("#Horaire_hum").data("kendoDateTimePicker");

    $("#Horaire_hum").click(function () {
        datepicker_hour.open("date");
    });
    
    function myfunctionheurrefresh() {
         
        var startTime = new Date($("#Horaire_hum").data("kendoDateTimePicker").value());
        var time = [], hum = [], orders_update = [], seuil_min = [], seuil_max = [],id = 0 ;
        var Min, Max;
        $.ajax({
            url: '../../UserSession/HumiditeClimatByIntervalOneHour',
            type: 'GET',
            data: {
                idNoeudClimat : @Model.ElementAt(0).IdParentNode,
                startTime : startTime
            },
            dataType: 'json',
            async: false,
            //beforeSend: function() {
            //    kendo.ui.progress($("#loading"), true);        
            //},
            success: function (res) {
                var i = 0;
                while ((res[i].HumiditeClimat == null) && (i < res.length - 1)) {
                    i++;
                }
                Min = res[i].HumiditeClimat;
                Max = res[i].HumiditeClimat; //alert(Min + '\n' + Max);
                for (var j = 0; j < res.length; j++) {
                    var date = new Date(Number(res[j].DateMesure.substring(6, 19)));
                    //list9.push([date.getTime(), res[j].TemperatureClimat]);
                    hum.push(res[j].HumiditeClimat);
                    time.push(res[j].DateMesure);
                    if (res[j].HumiditeClimat != null) {
                        orders_update.push({
                            ID: id ++,
                            OrderDate: kendo.format('{0:dd/MM/yyyy}',date),
                            Humidite: res[j].HumiditeClimat,
                        });
                        if(res[j].HumiditeClimat > Max)
                        {
                            Max = res[j].HumiditeClimat;
                        }
                        if(res[j].HumiditeClimat < Min)
                        {
                            Min = res[j].HumiditeClimat;
                        }
                        if(res[j].HumiditeClimat > list_seuil[1])
                        {
                            seuil_max.push([date.getTime(), res[j].HumiditeClimat]);
                        }
                        else
                        {
                            seuil_max.push([date.getTime(), null]);
                        }
                        if(res[j].HumiditeClimat < list_seuil[0])
                        {
                            seuil_min.push([date.getTime(), res[j].HumiditeClimat]);
                        }
                        else 
                        {
                            seuil_min.push([date.getTime(), null]);
                        }
                    }
                }
            },
            //complete: function() {
            //    kendo.ui.progress($("#loading"), false);
            //}
        });

        jQuery("#grid_hum").data("kendoGrid").dataSource.data(orders_update); 
        jQuery("#grid_hum").data("kendoGrid").refresh();
        
        //coloration grid 
        var grid = $("#grid_hum").data("kendoGrid");
        var data = grid.dataSource.data();
        $.each(data, function (i, row) {
            if (row.Humidite >= list_seuil[1])
                $('tr[data-uid="' + row.uid + '"] ').css("background-color", "#ffb1af");
            else if (row.Humidite < list_seuil[0])
                $('tr[data-uid="' + row.uid + '"] ').css("background-color", "#aedfe5");
        });
        
        var stockChart = $("#stock-chart_hum").data("kendoStockChart");
        stockChart.options.title.text = "time :" + kendo.format('{0:dd/MM/yyyy HH:mm}',startTime); 
        stockChart.options.categoryAxis[0].categories = time;
        stockChart.options.categoryAxis[0].labels.step = 5;
        stockChart.options.categoryAxis[0].majorTicks.step = 1;
        stockChart.options.categoryAxis[0].baseUnit = "minutes";
        stockChart.options.series[0].data = hum;
        stockChart.options.series[0].name = "Humidité";
        stockChart.options.series[0].markers.visible = false;
        stockChart.options.valueAxis[0].min = Min - (Max - Min) * 0.1;
        stockChart.options.valueAxis[0].max = Max + (Max - Min) * 0.1;
        stockChart.options.categoryAxis[1].categories = time;
        stockChart.options.categoryAxis[1].labels.step = 5;
        stockChart.options.categoryAxis[1].majorTicks.step = 1;
        stockChart.options.categoryAxis[1].baseUnit = "minutes";
//        stockChart.options.categoryAxis[0].select.from = stockChart.options.categoryAxis[0].min;  //give the new range values
//        stockChart.options.categoryAxis[0].select.to = stockChart.options.categoryAxis[0].max;
        stockChart._navigator.options.select.from =time[0];
        stockChart._navigator.options.select.to =time[time.length-1];
        stockChart.options.series[2].data = hum;
        stockChart.options.series[2].name = "Humidité";
        stockChart.options.series[2].markers.visible = false;
        stockChart.refresh();
    }

</script>



@*choix Day*@
<script type='text/javascript'>

    $("#Journaliere_hum").kendoDatePicker({        
        close: myfunctionDaterefresh,      
    });

	$(".k-input").css("background-color", "#e8e8e8");
	$(".k-state-hover> .k-picker-wrap > .k-state-default").css("visibility", "hidden");
	    
	var datepicker = $("#Journaliere_hum").data("kendoDatePicker");
	    
    $("#Journaliere_hum").click(function () {
	    datepicker.open("date");
	});

    function myfunctionDaterefresh() {

        var startTime = $("#Journaliere_hum").data("kendoDatePicker").value();
        if (startTime == null) {
            startTime = new Date();
        }
        //alert(startTime);
        var day = [], hum = [], orders_update = [],id = 0;
        var Min, Max;
        $.ajax({
            url: '../../UserSession/HumiditeClimatByIntervalOneDay',
            type: 'GET',
            data: {
                idNoeudClimat : @Model.ElementAt(0).IdParentNode,
                startTime : startTime
            },
            dataType: 'json',
            async: false,
            //beforeSend: function() {
            //    kendo.ui.progress($("#loading"), true);        
            //},
            success: function (res) {
                var i = 0;
                while ((res[i].HumiditeClimat == null) && (i < res.length - 1)) {
                    i++;
                }
                Min = res[i].HumiditeClimat;
                Max = res[i].HumiditeClimat;
                for (var j = 0; j < res.length; j++) {
                    var date = new Date(Number(res[j].DateMesure.substring(6, 19)));
                    hum.push(res[j].HumiditeClimat);
                    day.push(res[j].DateMesure);
                    //list9.push([date.getTime(), res[j].TemperatureClimat]);
                    if (res[j].HumiditeClimat != null) {
                        if(res[j].HumiditeClimat > Max)
                        {
                            Max = res[j].HumiditeClimat;
                        }
                        if(res[j].HumiditeClimat < Min)
                        {
                            Min = res[j].HumiditeClimat;
                        }
                        orders_update.push({
                            ID: id ++,
                            OrderDate: date,
                            Humidite: res[j].HumiditeClimat,
                        });
                    }
                }
            },
            //complete: function() {
            //    kendo.ui.progress($("#loading"), false);
            //}
        });

        $("#grid_hum").data("kendoGrid").dataSource.data(orders_update); 
        $("#grid_hum").data("kendoGrid").refresh();
        //coloration grid 
        var grid = $("#grid_hum").data("kendoGrid");
        var data = grid.dataSource.data();
        $.each(data, function (i, row) {
            if (row.Humidite >= list_seuil[1])
                $('tr[data-uid="' + row.uid + '"] ').css("background-color", "#ffb1af");
            else if (row.Humidite < list_seuil[0])
                $('tr[data-uid="' + row.uid + '"] ').css("background-color", "#B0E0E6");
        });

        var stockChart = $("#stock-chart_hum").data("kendoStockChart");
        stockChart.options.title.text = "Date :" + kendo.format('{0:dd/MM/yyyy}',startTime);
        stockChart.options.categoryAxis[0].labels.step = 120;
        stockChart.options.categoryAxis[0].majorTicks.step = 60;
        stockChart.options.categoryAxis[0].baseUnit = "minutes";
        stockChart.options.categoryAxis[0].categories = day;
        stockChart.options.series[0].markers.visible = false;
        stockChart.options.series[0].name = "Humidité";
        stockChart.options.series[0].data = hum;
        stockChart.options.valueAxis[0].min = Math.floor(Min - (Max - Min) * 0.1);
        stockChart.options.valueAxis[0].max = Math.ceil(Max + (Max - Min) * 0.1);
        stockChart.options.categoryAxis[1].categories = day;
        stockChart.options.categoryAxis[1].labels.step = 120;
        stockChart.options.categoryAxis[1].majorTicks.step = 60;
        stockChart.options.categoryAxis[1].baseUnit = "minutes";
        stockChart._navigator.options.select.from = day[0];
        stockChart._navigator.options.select.to = day[day.length-1];
        stockChart.options.series[2].data = hum;
        stockChart.options.series[2].name = "Humidité";
        stockChart.options.series[2].markers.visible = false;
        stockChart.refresh();
       
}
</script>

@* choix semaine*@
<script type='text/javascript'>

    $("#Hebdomadaire_hum").kendoDatePicker({
        change: myfonctionWeekRefresh
    });

    $(".k-input").css("background-color", "#e8e8e8");
    $(".k-state-hover> .k-picker-wrap > .k-state-default").css("visibility", "hidden");
	    
    var datepicker_Week = $("#Hebdomadaire_hum").data("kendoDatePicker");
    
    $("#Hebdomadaire_hum").click(function () {
        datepicker_Week.open("date");
    });

    function myfonctionWeekRefresh() {

        var tr = $(".k-state-selected", Hebdomadaire_hum._table).closest("tr");
        var day = this.value();
        var first = $("td:first", tr).find("a").attr("title");
        var last = $("td:last", tr).find("a").attr("title");
        var startTime = new Date(first), endTime = new Date(last); 
        //alert(first + '\n' + last);
        var week = [], temp = [], orders_update = [], seuil_min = [], seuil_max = [];
        var Min, Max, id = 1;
        $.ajax({
            url: '../../UserSession/HumiditeClimatByIntervalOneWeek',
            //url: '../../UserSession/TemperatureClimatByIntervalDatesDebutFin',
            type: 'GET',
            data: {
                idNoeudClimat : @Model.ElementAt(0).IdParentNode,
                startTime : startTime
            },
            dataType: 'json',
            async: false,
            //beforeSend: function() {
            //    kendo.ui.progress($("#loading1"), true);        
            //},
            success: function (res) { 
                var i = 0;
                while ((res[i].HumiditeClimat == null) && (i < res.length - 1)) {
                    i++;
                }
            //alert("res: " + res.length);
                Min = res[i].HumiditeClimat;
                Max = res[i].HumiditeClimat;
                for (var j = 0; j < res.length; j++) {
                    var date = new Date(Number(res[j].DateMesure.substring(6, 19)));
                    temp.push(res[j].HumiditeClimat);
                    week.push(res[j].DateMesure);
                    if (res[j].HumiditeClimat != null) {
                        orders_update.push({
                            ID: id ++,
                            OrderDate: date,
                            Humidite: res[j].HumiditeClimat,
                        });
                        if(res[j].HumiditeClimat > Max)
                        {
                            Max = res[j].HumiditeClimat;
                        }
                        if(res[j].HumiditeClimat < Min)
                        {
                            Min = res[j].HumiditeClimat;
                        }
                        if(res[j].HumiditeClimat > list_seuil[1])
                        {
                            seuil_max.push([date.getTime(), res[j].HumiditeClimat]);
                        }
                        else
                        {
                            seuil_max.push([date.getTime(), null]);
                        }
                        if(res[j].HumiditeClimat < list_seuil[0])
                        {
                            seuil_min.push([date.getTime(), res[j].HumiditeClimat]);
                        }
                        else 
                        {
                            seuil_min.push([date.getTime(), null]);
                        }
                    }
                }
            },
            //complete: function() {
            //    kendo.ui.progress($("#loading1"), false);
            //}
        });
        //alert("week: " + week.length + "\ntemp: " + temp.length + "\norders_update: " + orders_update.length);
        jQuery("#grid_hum").data("kendoGrid").dataSource.data(orders_update); 
        jQuery("#grid_hum").data("kendoGrid").refresh();
   
        //coloration grid 
        var grid = $("#grid_hum").data("kendoGrid");
        var data = grid.dataSource.data();
        $.each(data, function (i, row) {
            if (row.Humidite >= list_seuil[1])
                $('tr[data-uid="' + row.uid + '"] ').css("background-color", "#ffb1af");
            else if (row.Humidite < list_seuil[0])
                $('tr[data-uid="' + row.uid + '"] ').css("background-color", "#aedfe5");
        });

        var stockChart = $("#stock-chart_hum").data("kendoStockChart");
        stockChart.options.title.text = "Date debut : " + kendo.format('{0:dd/MM/yyyy}', first)+ "Date fin : " + kendo.format('{0:dd/MM/yyyy}', last);
        stockChart.options.categoryAxis[0].labels.step = 720;
        stockChart.options.categoryAxis[0].majorTicks.step = 300;
        stockChart.options.categoryAxis[0].baseUnit = "minutes";
        stockChart.options.categoryAxis[0].categories = week;
        stockChart.options.series[0].name = "Humidité";
        stockChart.options.series[0].markers.visible = false;
        stockChart.options.series[0].data = temp;
        stockChart.options.valueAxis[0].min = Math.floor(Min - (Max - Min) * 0.1);
        stockChart.options.valueAxis[0].max = Math.ceil(Max + (Max - Min) * 0.1);
        stockChart.options.categoryAxis[1].categories = week;
        stockChart.options.categoryAxis[1].labels.step = 480;
        stockChart.options.categoryAxis[1].majorTicks.step = 300;
        stockChart.options.categoryAxis[1].baseUnit = "minutes";
        stockChart.options.series[2].data = temp;
        stockChart.options.series[2].name = "Humidité";
        stockChart._navigator.options.select.from = week[0];
        stockChart._navigator.options.select.to = week[week.length-1];
        stockChart.options.series[2].markers.visible = false;
//      stockChart.options.navigator.series.type = "line";
        stockChart.refresh();
    }

</script>

@* Choix Mois *@
<script type='text/javascript'>
       
    $("#mensuelle_hum").kendoDatePicker({
        // defines the start view
        start: "year",

        // defines when the calendar should return date
        depth: "year",

        // display month and year in the input
        format: "MMMM yyyy",
        close: myfunctionMoisrefresh,
    });

	$(".k-input").css("background-color", "#e8e8e8");
	$(".k-state-hover> .k-picker-wrap > .k-state-default").css("visibility", "hidden");
	    
	var datepicker_month = $("#mensuelle_hum").data("kendoDatePicker");

	$("#mensuelle_hum").click(function () {
        datepicker_month.open("date");
	});

    function  myfunctionMoisrefresh()
    {
        var startTime = $("#mensuelle_hum").data("kendoDatePicker").value();
        var month = [], hum = [], orders_update = [], seuil_min = [], seuil_max = [];
        var Min, Max, id = 1;
        $.ajax({
            url: '../../UserSession/TemperatureClimatByIntervalOneMonth',
            type: 'GET',
            //beforeSend: function() {
            //    kendo.ui.progress($("#loading1"), true);        
            //},
            data: { idNoeudClimat : '@Model.ElementAt(0).IdParentNode', startTime : startTime },
            dataType: 'json',
            async: false,
            success: function (res) {
                var i = 0;
                while ((res[i].Hmoy == null) && (i < res.length - 1)) {
                    i++;
                }
                Min = res[i].Hmoy;
                Max = res[i].Hmoy;
                for (var j = 0; j < res.length; j++) {
                    var date = new Date(Number(res[j].DateMesureMoy.substring(6, 19)));
                    hum.push(res[j].Hmoy);
                    month.push(res[j].DateMesureMoy);
                    //list9.push([date.getTime(), res[j].Tmoy]);
                    if (res[j].Hmoy != null)
                    {
                        orders_update.push({
                            ID: id ++,
                            OrderDate: kendo.format('{0:dd/MM/yyyy}', date),
                            Humidite: res[j].Hmoy,
                        });
                        if(res[j].Hmoy > Max)
                        {
                            Max = res[j].Hmoy;
                        }
                        if(res[j].Hmoy < Min)
                        {
                            Min = res[j].Hmoy;
                        }
                        if(res[j].Hmoy > list_seuil[1])
                        {
                            seuil_max.push([date.getTime(), res[j].Hmoy]);
                        }
                        else
                        {
                            seuil_max.push([date.getTime(), null]);
                        }
                        if(res[j].Hmoy < list_seuil[0])
                        {
                            seuil_min.push([date.getTime(), res[j].Hmoy]);
                        }
                        else 
                        {
                            seuil_min.push([date.getTime(), null]);
                        }
                    }
                }
            },
            //complete: function() {
            //    kendo.ui.progress($("#loading1"), false);
            //}
        });

        jQuery("#grid_hum").data("kendoGrid").dataSource.data(orders_update); 
        jQuery("#grid_hum").data("kendoGrid").refresh();
   
        //coloration grid 
        var grid = $("#grid_hum").data("kendoGrid");
        var data = grid.dataSource.data();
        $.each(data, function (i, row) {
            if (row.Humidite >= list_seuil[1])
                $('tr[data-uid="' + row.uid + '"] ').css("background-color", "#ffb1af");
            else if (row.Humidite < list_seuil[0])
                $('tr[data-uid="' + row.uid + '"] ').css("background-color", "#aedfe5");
        });

        var stockChart = $("#stock-chart_hum").data("kendoStockChart");
        stockChart.options.title.text = "Mois : " + kendo.format('{0:MM/yyyy}',startTime);
//      stockChart.options.navigator.series.type = "line";
        stockChart.options.categoryAxis[0].categories = month;
        stockChart.options.categoryAxis[0].labels.step = 2;
        stockChart.options.categoryAxis[0].majorTicks.step = 1;
        stockChart.options.categoryAxis[0].baseUnit = "days";
        stockChart.options.series[0].name = "Humidité moyenne";
        stockChart.options.series[0].data = hum;
        stockChart.options.series[0].markers.visible = true;
        stockChart.options.valueAxis[0].min = Math.floor(Min - (Max - Min) * 0.1);
        stockChart.options.valueAxis[0].max = Math.ceil(Max + (Max - Min) * 0.1);
        stockChart.options.categoryAxis[1].categories = month;
        stockChart.options.categoryAxis[1].labels.step = 2;
        stockChart.options.categoryAxis[1].majorTicks.step = 1;
        stockChart.options.categoryAxis[1].baseUnit = "days";
        stockChart.options.series[2].data = hum;
        stockChart.options.series[2].name = "Humidité";
        stockChart.options.series[2].markers.visible = false;
        stockChart._navigator.options.select.from =month[0];
        stockChart._navigator.options.select.to =month[month.length-1];
        stockChart.refresh();
    }
</script>

@*choix periode*@
<script type='text/javascript'>

    $("#periodique_hum").click(function () {
        $("#window2").data("kendoWindow").center().open();
    });
        
    function startChange() {
        var startDate = start.value(), endDate = end.value();
        if (startDate) {
            startDate = new Date(startDate);
            startDate.setDate(startDate.getDate());
            end.min(startDate);
        } else if (endDate) {
            start.max(new Date(endDate));
        } else {
            endDate = new Date();
            start.max(endDate);
            end.min(endDate);
        }
    }

    function endChange() {

        var endDate = end.value(), startDate = start.value();

        if (endDate) {
            endDate = new Date(endDate);
            endDate.setDate(endDate.getDate());
            start.max(endDate);
        } else if (startDate) {
            end.min(new Date(startDate));
        } else {
            endDate = new Date();
            start.max(endDate);
            end.min(endDate);
        }
    }

    var start = $("#start").kendoDateTimePicker({
        change: startChange
    }).data("kendoDateTimePicker");

    var end = $("#end").kendoDateTimePicker({
        change: endChange,
//        close: myfunctionperiodrefresh,
    }).data("kendoDateTimePicker");

    start.max(end.value());
    end.min(start.value());  
      
    $("#check").kendoButton({
        click: RefreshPeriod,
        imageUrl: "../content/images/connection.png",
    });
    $("#Annuler_hum").kendoButton({
        click: exit,
        imageUrl: "../content/images/cancel.png",
    });
      function exit()
      {
      $("#window2").data("kendoWindow").center().close();
      } 
//    $("#check").click(function () {
      function RefreshPeriod()
      {
        $("#window2").data("kendoWindow").center().close();

        var startTime = $("#start").data("kendoDateTimePicker").value();
        var endTime = $("#end").data("kendoDateTimePicker").value();
        var interval = [], hum = [], orders_update = [], seuil_min = [], seuil_max = [];
        var Min, Max, id = 1;
        $.ajax({
            url: '../../UserSession/HumiditeClimatByInterval',
            type: 'GET',
            //beforeSend: function() {
            //    kendo.ui.progress($("#loading1"), true);        
            //},
            data: {
                idNoeudClimat : '@Model.ElementAt(0).IdParentNode',
                startTime : startTime,
                endTime : endTime
            },
            dataType: 'json',
            async: false,
            success: function (res) {
                var i =0 ;
                while ((res[i].HumiditeClimat == null) && (i < res.length - 1)) {
                    i++;
                }
                Min = res[i].HumiditeClimat;
                Max = res[i].HumiditeClimat;
                for (var j = 0; j < res.length; j++) {                    
                    var date = new Date(Number(res[j].DateMesure.substring(6, 19)));
                    interval.push(res[j].DateMesure);
                    hum.push(res[j].HumiditeClimat);
//                    list9.push([date.getTime(), res[j].TemperatureClimat]);
                    if (res[j].HumiditeClimat != null) {
                        orders_update.push({
                            ID: id ++,
                            OrderDate: date,
                            Humidite: res[j].HumiditeClimat,
                        });
                        if(res[j].HumiditeClimat > Max)
                        {
                            Max = res[j].HumiditeClimat;
                        }
                        if(res[j].HumiditeClimat < Min)
                        {
                            Min = res[j].HumiditeClimat;
                        }
                        if(res[j].HumiditeClimat > list_seuil[1])
                        {
                            seuil_max.push([date.getTime(), res[j].HumiditeClimat]);
                        }
                        else
                        {
                            seuil_max.push([date.getTime(), null]);
                        }
                        if(res[j].HumiditeClimat < list_seuil[0])
                        {
                            seuil_min.push([date.getTime(), res[j].HumiditeClimat]);
                        }
                        else 
                        {
                            seuil_min.push([date.getTime(), null]);
                        }
                    }
                }
            },
            //complete: function() {
            //    kendo.ui.progress($("#loading1"), false);
            //}
        });

        $("#grid_hum").data("kendoGrid").dataSource.data(orders_update); 
        $("#grid_hum").data("kendoGrid").refresh();

        //coloration grid 
        var grid = $("#grid_hum").data("kendoGrid");
        var data = grid.dataSource.data();
        $.each(data, function (i, row) {
            if (row.Humidite >= list_seuil[1])
                $('tr[data-uid="' + row.uid + '"] ').css("background-color", "#ffb1af");
            else if (row.Humidite < list_seuil[0])
                $('tr[data-uid="' + row.uid + '"] ').css("background-color", "#aedfe5");
        });
        
        var stockChart = $("#stock-chart_hum").data("kendoStockChart");
        stockChart.options.title.text = "Date debut:" + kendo.format('{0:MM/yyyy}',startTime) + " - date fin: " + kendo.format('{0:MM/yyyy}',endTime); 
        stockChart.options.categoryAxis[0].categories = interval;
        stockChart.options.categoryAxis[0].labels.step = 2400;
        stockChart.options.categoryAxis[0].majorTicks.step = 1200;
        stockChart.options.categoryAxis[0].baseUnit = "minutes";
        stockChart.options.series[0].markers.visible = false;
        stockChart.options.series[0].name = "Humidité";
        stockChart.options.series[0].data = hum;
        stockChart.options.valueAxis[0].min = Math.floor(Min - (Max - Min) * 0.1);
        stockChart.options.valueAxis[0].max = Math.ceil(Max + (Max - Min) * 0.1);
        stockChart.options.categoryAxis[1].categories = interval;
        stockChart.options.categoryAxis[1].labels.step = 600;
        stockChart.options.categoryAxis[1].majorTicks.step = 600;
        stockChart.options.categoryAxis[1].baseUnit = "minutes";
        stockChart._navigator.options.select.from = interval[0];
        stockChart._navigator.options.select.to = interval[interval.length-1];
        stockChart.options.series[2].name = "Humidité";
        stockChart.options.series[2].data = hum;
        stockChart.refresh();
//    });
      }
</script>

@* reporting*@
<script type="text/javascript">

    $("#refresh").click(function () {
        myfunctionDaterefresh();
    });

    //    function clickMonBoutonPdf() {
    $("#MonBoutonExcel").click(function () {
        var chart = $("#stock-chart_hum").data("kendoStockChart");
        var image = chart.imageDataURL(); //Kendo UI
        var a = $("<a>").attr("href", image).attr("download", "img.png").appendTo("body");
        a[0].click();
        a.remove();
    });
    //    }

    //    function clickMonBoutonExcel() {
    $("#MonBoutonPdf").click(function () {
        var dataSource = $("#grid_hum").data("kendoGrid").dataSource;
        var filteredDataSource = new kendo.data.DataSource({
            data: dataSource.data(),
            filter: dataSource.filter()
        });

        filteredDataSource.read();
        var data = filteredDataSource.view();
        var result = "data:application/vnd.ms-excel,";
        result += "<table><tr><th>Date</th><th>Température °C</th><th> Date</th></tr>";
        for (var i = 0; i < data.length; i++) {
            var datee = data[i].OrderDate;
            result += "<tr>";
            result += "<td>";
            result += kendo.format('{0:dd/MM/yyyy HH:mm}', datee);
            result += "</td>";
            result += "<td>";
            result += data[i].Humidite;
            result += "</td>";
            result += "</tr>";
        }
        result += "</table>";
        if (window.navigator.msSaveBlob) {
            window.navigator.msSaveBlob(new Blob([result]), 'export.csv');
        } else {
            window.open(result);
        }
    });
    //    }
</script>